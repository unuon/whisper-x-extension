"use strict";var N=Object.create;var I=Object.defineProperty;var ee=Object.getOwnPropertyDescriptor;var oe=Object.getOwnPropertyNames;var re=Object.getPrototypeOf,se=Object.prototype.hasOwnProperty;var te=(r,e)=>()=>(r&&(e=r(r=0)),e);var j=(r,e)=>{for(var o in e)I(r,o,{get:e[o],enumerable:!0})},G=(r,e,o,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of oe(e))!se.call(r,t)&&t!==o&&I(r,t,{get:()=>e[t],enumerable:!(s=ee(e,t))||s.enumerable});return r};var v=(r,e,o)=>(o=r!=null?N(re(r)):{},G(e||!r||!r.__esModule?I(o,"default",{value:r,enumerable:!0}):o,r)),ne=r=>G(I({},"__esModule",{value:!0}),r);var B={};j(B,{WHISPER_MODELS:()=>M,getAvailableModels:()=>A,getEnglishOnlyModels:()=>_,getModelInfo:()=>le,getMultilingualModels:()=>Y,getRecommendedModels:()=>R});function le(r){return M.find(e=>e.name===r)}function A(){return M.map(r=>r.name)}function R(){return M.filter(r=>r.recommended)}function _(){return M.filter(r=>r.englishOnly)}function Y(){return M.filter(r=>!r.englishOnly)}var M,P=te(()=>{"use strict";M=[{name:"tiny",size:"~75 MB",description:"Fastest, least accurate. Good for quick testing.",englishOnly:!1,recommended:!1},{name:"tiny.en",size:"~75 MB",description:"Fastest, English-only. Good for quick English transcription.",englishOnly:!0,recommended:!1},{name:"base",size:"~142 MB",description:"Fast and decent accuracy. Good balance for multilingual.",englishOnly:!1,recommended:!0},{name:"base.en",size:"~142 MB",description:"Fast and decent accuracy. Good balance for English.",englishOnly:!0,recommended:!0},{name:"small",size:"~466 MB",description:"Better accuracy, slower processing. Good for quality multilingual transcription.",englishOnly:!1,recommended:!1},{name:"small.en",size:"~466 MB",description:"Better accuracy, slower processing. Good for quality English transcription.",englishOnly:!0,recommended:!1},{name:"medium",size:"~1.5 GB",description:"High accuracy, requires more resources. Professional multilingual transcription.",englishOnly:!1,recommended:!1},{name:"medium.en",size:"~1.5 GB",description:"High accuracy, requires more resources. Professional English transcription.",englishOnly:!0,recommended:!1},{name:"large-v1",size:"~3 GB",description:"Highest accuracy, very slow. For best quality multilingual transcription.",englishOnly:!1,recommended:!1},{name:"large",size:"~3 GB",description:"Highest accuracy, very slow. Latest large model.",englishOnly:!1,recommended:!1},{name:"large-v3-turbo",size:"~1.6 GB",description:"Fast large model with good accuracy. Best overall for production use.",englishOnly:!1,recommended:!0}]});var de={};j(de,{WHISPER_MODELS:()=>M,WhisperX:()=>g,default:()=>ae,deleteModel:()=>C,downloadModel:()=>O,getAvailableModels:()=>A,getBaseDirectory:()=>E,getEnglishOnlyModels:()=>_,getModelInfo:()=>b,getMultilingualModels:()=>Y,getRecommendedModels:()=>R,listAvailableModels:()=>k,listInstalledModels:()=>T,main:()=>ce,setBaseDirectory:()=>S});module.exports=ne(de);var x=v(require("path"),1),F=require("child_process"),a=require("fs"),q=v(require("os"),1),g=class{baseDirectory;constructor(e){this.baseDirectory=e||process.cwd()}getModelsDirectory(){return x.default.join(this.baseDirectory,"node_modules","nodejs-whisper","cpp","whisper.cpp","models")}getModelPath(e){return x.default.join(this.getModelsDirectory(),`ggml-${e}.bin`)}isModelInstalled(e){return(0,a.existsSync)(this.getModelPath(e))}async downloadModel(e,o=3){try{if(this.isModelInstalled(e))return console.log(`[WhisperX] \u2713 Model ${e} is already installed`),!0;let s=this.getModelsDirectory(),t=q.default.platform()==="win32";if(!(0,a.existsSync)(s))return console.error(`[WhisperX] Models directory does not exist: ${s}`),console.error("[WhisperX] Please ensure nodejs-whisper is properly installed"),!1;let n=t?"download-ggml-model.cmd":"download-ggml-model.sh",c=x.default.join(s,n);if(!(0,a.existsSync)(c))return console.error(`[WhisperX] Download script not found: ${c}`),console.error("[WhisperX] Please ensure nodejs-whisper is properly installed"),!1;console.log(`[WhisperX] Platform: ${t?"Windows":"Unix-like"}`),console.log(`[WhisperX] Model: ${e}`),console.log();let l=0;for(;l<o;){if(l++,l>1&&console.log(`[WhisperX] Retry attempt ${l}/${o}...`),await this.executeDownloadScript(t,s,e)&&this.isModelInstalled(e)){let d=this.getModelSize(e),$=d?this.formatSize(d):"Unknown";return console.log(`[WhisperX] \u2713 Model installed successfully (${$})`),!0}let m=this.getModelPath(e),X=(0,a.existsSync)(m);l<o&&(X&&console.log("[WhisperX] Partial download detected, will resume..."),console.log("[WhisperX] Retrying in 3 seconds..."),await new Promise(d=>setTimeout(d,3e3)))}return console.error(`[WhisperX] \u2717 Failed to download model after ${o} attempts`),!1}catch(s){return console.error(`[WhisperX] Error downloading model ${e}:`,s),!1}}executeDownloadScript(e,o,s){return new Promise(t=>{let n=e?process.env.COMSPEC||"C:\\Windows\\System32\\cmd.exe":"/bin/bash",l=(0,F.spawn)(n,e?["/c","download-ggml-model.cmd",s]:["download-ggml-model.sh",s],{cwd:o,windowsHide:!0,stdio:["ignore","pipe","pipe"]}),h=-1,m="",X="",d=!1,$=p=>{let y=p.split(`
`);for(let f of y){let W=f.trim();if(!W)continue;let D=W.match(/(\d+)%/);if(D&&D[1]){let w=parseInt(D[1],10);if(w!==h&&(w%10===0||w===100||!d)){h=w,d=!0;let L=`[WhisperX] Downloading ${s}: ${w}%`;process.stdout.isTTY?(process.stdout.clearLine(0),process.stdout.cursorTo(0),process.stdout.write(L)):console.log(L)}}else W.toLowerCase().includes("downloading")&&!d?console.log(`[WhisperX] Starting download: ${s}`):(W.toLowerCase().includes("resuming")||W.toLowerCase().includes("continue"))&&console.log(`[WhisperX] Resuming download: ${s}`)}};l.stdout&&l.stdout.on("data",p=>{let y=p.toString();m+=y,$(m)}),l.stderr&&l.stderr.on("data",p=>{let y=p.toString();X+=y,$(X);let f=y.trim();f&&!f.includes("%")&&!f.match(/^[\.\s]+$/)&&(f.toLowerCase().includes("error")||f.toLowerCase().includes("failed")||f.toLowerCase().includes("warning"))&&(process.stdout.isTTY&&d&&process.stdout.write(`
`),console.error(`[WhisperX] ${f}`))}),l.on("close",p=>{process.stdout.isTTY&&d&&process.stdout.write(`
`),p===0?console.log(`[WhisperX] \u2713 Download completed: ${s}`):console.error(`[WhisperX] \u2717 Download failed: ${s} (exit code: ${p})`),t(p===0)}),l.on("error",p=>{process.stdout.isTTY&&d&&process.stdout.write(`
`),console.error("[WhisperX] Failed to start download process:",p),p.message.includes("ENOENT")&&(e?(console.error(`[WhisperX] Could not find command: ${n}`),console.error("[WhisperX] Troubleshooting:"),console.error("[WhisperX]   1. Verify nodejs-whisper is properly installed"),console.error("[WhisperX]   2. Check if Windows System32 is in PATH"),console.error("[WhisperX]   3. Try running as administrator")):(console.error("[WhisperX] Could not find bash or download script"),console.error(`[WhisperX] Ensure the script exists and is executable in: ${o}`))),t(!1)});let Z=setTimeout(()=>{process.stdout.isTTY&&d&&process.stdout.write(`
`),console.warn("[WhisperX] Download timeout (10 minutes), terminating..."),l.kill("SIGTERM"),t(!1)},600*1e3);l.on("close",()=>clearTimeout(Z))})}async deleteModel(e){try{let o=this.getModelPath(e);return(0,a.existsSync)(o)?(console.log(`[WhisperX] Deleting model: ${e}`),(0,a.unlinkSync)(o),console.log(`[WhisperX] Successfully deleted model: ${e}`),!0):(console.log(`[WhisperX] Model ${e} is not installed`),!1)}catch(o){return console.error(`[WhisperX] Error deleting model ${e}:`,o),!1}}listInstalledModels(){try{let e=this.getModelsDirectory();return(0,a.existsSync)(e)?(0,a.readdirSync)(e).filter(s=>s.startsWith("ggml-")&&s.endsWith(".bin")).map(s=>s.replace("ggml-","").replace(".bin","")):[]}catch(e){return console.error("[WhisperX] Error listing models:",e),[]}}getInstalledModelsInfo(){return this.listInstalledModels().map(o=>{let s=this.getModelSize(o);return{name:o,size:s?this.formatSize(s):"Unknown",path:this.getModelPath(o)}})}getModelSize(e){try{let o=this.getModelPath(e);return(0,a.existsSync)(o)?(0,a.statSync)(o).size:null}catch(o){return console.error("[WhisperX] Error getting model size:",o),null}}formatSize(e){let o=["Bytes","KB","MB","GB"];if(e===0)return"0 Bytes";let s=Math.floor(Math.log(e)/Math.log(1024));return`${Math.round(e/Math.pow(1024,s)*100)/100} ${o[s]}`}};var H;function S(r){H=r,console.log(`[WhisperX] Base directory set to: ${r}`)}function E(){return H}function i(){return new g(E())}function u(r){return r instanceof Error?r.message:String(r)}function z(r,e){let o=r.isModelInstalled(e),s=r.getModelPath(e),t=null;if(o){let n=r.getModelSize(e);t=n?r.formatSize(n):null}return{modelName:e,isInstalled:o,path:s,size:t}}async function b(r,e){r.stopPropagation();try{console.log(`[WhisperX] Getting info for model: ${e}`);let o=i();return{ok:!0,data:z(o,e)}}catch(o){return console.error("[WhisperX] Error getting model info:",o),{ok:!1,error:u(o)}}}async function k(r){r.stopPropagation();try{console.log("[WhisperX] Listing available models");let{WHISPER_MODELS:e}=await Promise.resolve().then(()=>(P(),B));return{ok:!0,data:{models:e}}}catch(e){return console.error("[WhisperX] Error listing available models:",e),{ok:!1,error:u(e)}}}async function T(r){r.stopPropagation();try{return console.log("[WhisperX] Listing installed models"),{ok:!0,data:{models:i().getInstalledModelsInfo()}}}catch(e){return console.error("[WhisperX] Error listing installed models:",e),{ok:!1,error:u(e)}}}async function ie(r,e,o){let s=!1;function t(n,c){s||(s=!0,console.log(`[WhisperX] ${c}`),setTimeout(()=>{o.sender.send(r,{type:"completion",data:{log:c,exitCode:n?0:1,controllerId:r,modelName:e}})},100))}try{console.log(`[WhisperX] Starting model download: ${e}`),o.sender.send(r,{type:"progress",data:{log:`Downloading model: ${e}`,progress:0,controllerId:r,modelName:e}});let n=i();if(n.isModelInstalled(e))return t(!0,`Model ${e} is already installed`),{success:!0,modelName:e,alreadyInstalled:!0};if(await n.downloadModel(e)){let l=n.getModelSize(e),h=l?n.formatSize(l):"Unknown size";return t(!0,`Model ${e} downloaded successfully (${h})`),{success:!0,modelName:e}}else return t(!1,`Failed to download model: ${e}`),{success:!1,modelName:e,error:"Download failed"}}catch(n){let c=u(n);return t(!1,`Error downloading model: ${c}`),{success:!1,modelName:e,error:c}}}async function O(r,e,o){r.stopPropagation();let{modelName:s}=o,{invokeEvent:t}=r;console.log(`[WhisperX] Download request: ${e} -> ${s}`);let n=await ie(e,s,t);return{downloadId:e,controllerId:e,result:n}}async function C(r,e){r.stopPropagation();let{modelName:o}=e;try{console.log(`[WhisperX] Delete request: ${o}`);let s=i();return s.isModelInstalled(o)?await s.deleteModel(o)?(console.log(`[WhisperX] Successfully deleted model: ${o}`),{ok:!0,data:{modelName:o,message:`Model ${o} deleted successfully`}}):{ok:!1,data:{modelName:o,error:"Failed to delete model"}}:(console.log(`[WhisperX] Model ${o} is not installed`),{ok:!1,data:{modelName:o,notFound:!0,message:`Model ${o} is not installed`}})}catch(s){return console.error("[WhisperX] Error deleting model:",s),{ok:!1,error:u(s)}}}async function U(r,e){try{let o=i();return{success:!0,data:z(o,e)}}catch(o){return console.error("[WhisperX] Error getting model info:",o),{success:!1,error:o.message}}}async function K(){try{let{WHISPER_MODELS:r}=await Promise.resolve().then(()=>(P(),B));return{success:!0,models:r}}catch(r){return console.error("[WhisperX] Error listing available models:",r),{success:!1,error:r.message}}}async function V(){try{return{success:!0,models:i().getInstalledModelsInfo()}}catch(r){return console.error("[WhisperX] Error listing installed models:",r),{success:!1,error:r.message}}}async function J(r,e){try{console.log(`[WhisperX] IPC download request: ${e}`);let o=i();if(o.isModelInstalled(e)){let t=o.getModelSize(e);return{success:!0,alreadyInstalled:!0,message:`Model ${e} is already installed`,size:t?o.formatSize(t):null}}if(await o.downloadModel(e)){let t=o.getModelSize(e);return{success:!0,message:`Model ${e} downloaded successfully`,size:t?o.formatSize(t):null}}else return{success:!1,error:"Download failed"}}catch(o){return console.error("[WhisperX] Error downloading model:",o),{success:!1,error:o.message}}}async function Q(r,e){try{console.log(`[WhisperX] IPC delete request: ${e}`);let o=i();return o.isModelInstalled(e)?await o.deleteModel(e)?{success:!0,message:`Model ${e} deleted successfully`}:{success:!1,error:"Failed to delete model"}:{success:!1,notFound:!0,message:`Model ${e} is not installed`}}catch(o){return console.error("[WhisperX] Error deleting model:",o),{success:!1,error:o.message}}}P();var ae=g;function ce({events:r,channels:e,electron:{ipcMain:o}}){let s=__dirname,t=s.replace(/[\\/]dist$/,"");console.log(`[Extendr] Extension path: ${s}`),console.log(`[Extendr] Extension root: ${t}`),S(t);let n=e.register("extendr:getModelInfo"),c=e.register("extendr:listAvailable"),l=e.register("extendr:listInstalled"),h=e.register("extendr:downloadModel"),m=e.register("extendr:deleteModel");r.on(n,b,-10),r.on(c,k,-10),r.on(l,T,-10),r.on(h,O,-10),r.on(m,C,-10),o.handle(n,U),o.handle(c,K),o.handle(l,V),o.handle(h,J),o.handle(m,Q),console.log("[Extendr] Extension initialized successfully")}0&&(module.exports={WHISPER_MODELS,WhisperX,deleteModel,downloadModel,getAvailableModels,getBaseDirectory,getEnglishOnlyModels,getModelInfo,getMultilingualModels,getRecommendedModels,listAvailableModels,listInstalledModels,main,setBaseDirectory});
